#*
#* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#* SPDX-License-Identifier: MIT-0
#*
#* Permission is hereby granted, free of charge, to any person obtaining a copy of this
#* software and associated documentation files (the "Software"), to deal in the Software
#* without restriction, including without limitation the rights to use, copy, modify,
#* merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
#* permit persons to whom the Software is furnished to do so.
#*
#* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
#* INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
#* PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
#* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#* OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
#* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#*

#------------------------------------------------------------------------------
#
# Template: opsmgmt-deploy-test-instances.yaml
# Purpose:  CloudFormation template to deploy test instances for patching using multi-account/multi-Region Automation
#
#
#------------------------------------------------------------------------------

AWSTemplateFormatVersion: '2010-09-09'
Description: AWS CloudFormation template to launch instances for Inventory, Patching, and Compliance demo environment for AWS Systems Manager

#-----------------------------------------------------------
# Parameters
#-----------------------------------------------------------
Parameters :
  LatestAmazonLinuxAmiId :
    # Use public Systems Manager Parameter
    Type : 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
  MainRegion: 
    Type: 'String' 
    Description: 'Main region for IAM.' 
    Default: 'us-east-1'

Conditions:
  IsMainRegion: !Equals [!Ref MainRegion, !Ref AWS::Region] 

Resources:

  #-------------------------------------------------
  # Key used to encrypt AWS Config data
  #-------------------------------------------------
  ConfigDataEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: Key used to encrypt AWS Config data
      Enabled: True
      EnableKeyRotation: True
      KeyPolicy:
        Version: '2012-10-17'
        Id: Policy_ID
        Statement:
        - Sid: Enable IAM User Permissions
          Effect: Allow
          Principal:
            AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
          Action: kms:*
          Resource: '*'
        - Sid: AWSConfigKMSPolicy
          Effect: Allow
          Principal:
            Service: config.amazonaws.com
          Action:
          - kms:Decrypt
          - kms:GenerateDataKey
          Resource: "*"

  ConfigEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/Config-DataEncryptionKey
      TargetKeyId: !Ref ConfigDataEncryptionKey

  #-------------------------------------------------
  # Bucket used to store AWS Config data
  #-------------------------------------------------
  ConfigCentralBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub aws-config-ssm-workshop-${AWS::AccountId}
      AccessControl: BucketOwnerFullControl
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              KMSMasterKeyID: !Ref ConfigDataEncryptionKey
              SSEAlgorithm: aws:kms
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  #-------------------------------------------------
  # Bucket policy to add to S3 bucket to store AWS Config data
  #-------------------------------------------------
  ConfigCentralBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ConfigCentralBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AWSConfigBucketPermissionsCheck
          Effect: Allow
          Principal:
            Service:
            - config.amazonaws.com
          Action: s3:GetBucketAcl
          Resource: !GetAtt ConfigCentralBucket.Arn
        - Sid: AWSConfigBucketExistenceCheck
          Effect: Allow
          Principal:
            Service:
            - config.amazonaws.com
          Action: s3:ListBucket
          Resource: !GetAtt ConfigCentralBucket.Arn
        - Sid: AWSConfigBucketDelivery
          Effect: Allow
          Principal:
            Service:
            - config.amazonaws.com
          Action: s3:PutObject
          Resource: 
            - !Sub arn:aws:s3:::${ConfigCentralBucket}/AWSLogs/${AWS::AccountId}/Config/*
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control

  #-------------------------------------------------
  # SNS Topic for AWS Config
  #-------------------------------------------------
  ConfigSNSTopic:
    Type: AWS::SNS::Topic
    Properties: 
      KmsMasterKeyId: !Ref ConfigDataEncryptionKey
      TopicName: aws-config-sns

  #-------------------------------------------------
  # SNS Topic policy for AWS Config
  #-------------------------------------------------
  ConfigSNSTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties: 
      PolicyDocument: 
        Id: Policy_ID
        Statement:
        - Sid: AWSConfigSNSPolicy
          Effect: Allow
          Principal:
            Service: config.amazonaws.com
          Action: SNS:Publish
          Resource: !Ref ConfigSNSTopic
      Topics: 
        - !Ref ConfigSNSTopic

  #-------------------------------------------------
  # IAM service role for AWS Config
  #-------------------------------------------------
  ConfigRole:
    Type: AWS::IAM::ServiceLinkedRole
    Properties:
      AWSServiceName: config.amazonaws.com

  #-------------------------------------------------
  # AWS Config Recorder
  #-------------------------------------------------
  ConfigRecorder:
    Type: AWS::Config::ConfigurationRecorder
    Properties:
      RecordingGroup:
        ResourceTypes:
          - 'AWS::EC2::Instance'
          - 'AWS::SSM::PatchCompliance'
          - 'AWS::SSM::AssociationCompliance'
          - 'AWS::SSM::FileData'
      RoleARN:
        Fn::Sub:
          "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/config.amazonaws.com/AWSServiceRoleForConfig"

  #-------------------------------------------------
  # AWS Config Delivery Channel
  #-------------------------------------------------
  ConfigDeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    Properties:
      S3BucketName: !Ref ConfigCentralBucket
      SnsTopicARN: !Ref ConfigSNSTopic

  #-------------------------------------------------
  # Automation Administration role for multi-account/Region Automation capabilities
  #-------------------------------------------------
  AutomationAdministrationServiceRole:
    Type: AWS::IAM::Role
    Condition: IsMainRegion
    Properties:
      RoleName: AWS-SystemsManager-AutomationAdministrationRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: ssm.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
      Policies:
      - PolicyName: AssumeRole-AWSSystemsManagerAutomationExecutionRole
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - sts:AssumeRole
            Resource:
              Fn::Sub: arn:${AWS::Partition}:iam::${AWS::AccountId}:role/AWS-SystemsManager-AutomationExecutionRole
          - Effect: Allow
            Action:
            - organizations:ListAccountsForParent
            Resource:
            - "*"

  #-------------------------------------------------
  # Automation Execution role for multi-account/Region Automation capabilities
  #-------------------------------------------------
  AutomationExecutionServiceRole:
    Type: AWS::IAM::Role
    Condition: IsMainRegion
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ssm.amazonaws.com
            AWS: 
            - !GetAtt AutomationAdministrationServiceRole.Arn
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonSSMAutomationRole
      Path: "/"
      RoleName: AWS-SystemsManager-AutomationExecutionRole
      Policies:
      - PolicyName: passRole
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - iam:PassRole
            Resource: 
            - Fn::Sub: arn:${AWS::Partition}:iam::${AWS::AccountId}:role/AWS-SystemsManager-AutomationExecutionRole
      - PolicyName: getTagPermissions
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - tag:GetResources
            Resource: "*"
      - PolicyName: listResourceGroupResourcesPermissions
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - resource-groups:listGroupResources
            Resource: "*"

  #-------------------------------------------------
  # Key used to encrypt resource data sync data
  #-------------------------------------------------
  ManagedInstanceDataEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: Key used to encrypt instance data
      Enabled: True
      EnableKeyRotation: True
      KeyPolicy:
        Version: '2012-10-17'
        Id: AccountPolicy
        Statement:
        - Sid: Enable IAM User Permissions
          Effect: Allow
          Principal:
            AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
          Action: kms:*
          Resource: '*'
        - Sid: Allow use of the key by Systems Manager
          Effect: Allow
          Principal:
            Service: ssm.amazonaws.com
          Action:
            - kms:DescribeKey
            - kms:Encrypt
            - kms:Decrypt
            - kms:ReEncrypt*
            - kms:GenerateDataKey
            - kms:GenerateDataKeyWithoutPlaintext
          Resource: '*'

  ManagedInstanceDataEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/SSM-ManagedInstanceDataEncryptionKey
      TargetKeyId: !Ref ManagedInstanceDataEncryptionKey

  #-------------------------------------------------
  # Bucket used to store resource data sync data
  #-------------------------------------------------
  ResouceSyncBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ssm-resource-sync-${AWS::Region}-${AWS::AccountId}'
      AccessControl: BucketOwnerFullControl
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              KMSMasterKeyID: !Ref ManagedInstanceDataEncryptionKey
              SSEAlgorithm: aws:kms
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  #-------------------------------------------------
  # Bucket policy to add to S3 bucket to store resource data sync data
  #-------------------------------------------------
  ResouceSyncBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ResouceSyncBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: SSMBucketPermissionsCheck
          Effect: Allow
          Principal:
            Service: ssm.amazonaws.com
          Action: s3:GetBucketAcl
          Resource: !GetAtt ResouceSyncBucket.Arn
        - Sid: SSMBucketDelivery
          Effect: Allow
          Principal:
            Service: ssm.amazonaws.com
          Action: s3:PutObject
          Resource:
          - !Join [ '', [!GetAtt ResouceSyncBucket.Arn, '/inventory/*/', 'accountid=', !Ref 'AWS::AccountId', '/*'] ]
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control

  #-------------------------------------------------
  # Resource Data Sync to aggregate inventory, patching, and compliance data in the central S3 bucket
  #-------------------------------------------------
  ResourceDataSync:
    Type: AWS::SSM::ResourceDataSync
    Properties: 
      SyncName: inventory-ssm-workshop
      S3Destination:
        BucketName: !Ref ResouceSyncBucket
        BucketPrefix: inventory
        BucketRegion: !Ref "AWS::Region"
        KMSKeyArn: !GetAtt ManagedInstanceDataEncryptionKey.Arn
        SyncFormat: 'JsonSerDe'
          
  #-------------------------------------------------
  # Bucket used to store instance command logs
  #-------------------------------------------------
  CommandLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ssm-command-logs-${AWS::Region}-${AWS::AccountId}'
      AccessControl: BucketOwnerFullControl
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
          
  #-------------------------------------------------
  # Bucket policy to add to S3 bucket to store command logs
  #-------------------------------------------------
  # CommandLogsBucketPolicy:
    # Type: AWS::S3::BucketPolicy
    # Properties:
      # Bucket: !Ref CommandLogsBucket
      # PolicyDocument:
        # Statement:
        # - Sid: SSMWrite
          # Effect: Allow
          # Principal: "*"
          # Action: 
            # - s3:PutObject
            # - s3:PutObjectAcl
          # Resource: 
            # - !Join [ '', [!GetAtt CommandLogsBucket.Arn, '/*'] ]

  #-------------------------------------------------
  # Resource Group to target for multi-account/multi-Region Automation
  #-------------------------------------------------
  WebServersRG:
    Type: AWS::ResourceGroups::Group
    Properties: 
      Description: 'This is a test Resource Group'
      Name: WebServers
      ResourceQuery: 
        Type: "TAG_FILTERS_1_0"
        Query: 
          ResourceTypeFilters:
           - "AWS::AllSupported"
          TagFilters:
            -
              Key: "Patch"
              Values: 
                - "True"

  #-------------------------------------------------
  # IAM role and instance profile to enable Systems Manager registration on EC2 instances
  #-------------------------------------------------
  ManagedInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Path: "/"
      RoleName: !Join [ '-', ['AmazonSSMManagedInstanceCore', !Ref 'AWS::Region'] ]
      Policies:
      - PolicyName: CWL_S3_KMS_Permissions
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:PutObject
            - s3:PutObjectAcl
            Resource: 
              - !Join [ '', [!GetAtt CommandLogsBucket.Arn] ]
              - !Join [ '', [!GetAtt CommandLogsBucket.Arn, '/*'] ]
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource: !Sub 'arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:key:*'
          - Effect: Allow
            Action:
            - logs:DescribeLogGroups
            - logs:DescribeLogStreams
            Resource: '*'
          - Effect: Allow
            Action:
            - logs:CreateLogStream
            Resource: !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:session-manager:*'
          - Effect: Allow
            Action:
            - logs:PutLogEvents
            Resource: !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:session-manager:log-stream:*'
              
  ManagedInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
      - !Ref ManagedInstanceRole
      InstanceProfileName: !Sub 'ManagedInstanceProfile-${AWS::Region}'
      
  #-------------------------------------------------
  # Key used to encrypt CloudWatch and Session Manager related data
  #-------------------------------------------------
  SessionManagerDataEncryptionKey:
    DependsOn: ManagedInstanceRole
    Type: AWS::KMS::Key
    Properties:
      Description: Key used to encrypt Session Manager related data
      Enabled: True
      EnableKeyRotation: True
      KeyPolicy:
        Version: '2012-10-17'
        Id: AccountPolicy
        Statement:
        - Sid: Enable IAM User Permissions
          Effect: Allow
          Principal:
            AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
          Action: kms:*
          Resource: '*'
        - Sid: Allow use of the key by the instance
          Effect: Allow
          Principal:
            AWS: 
            - !Join [ '', ['arn',':', !Ref 'AWS::Partition',':', 'iam','::', !Ref 'AWS::AccountId',':', 'role/AmazonSSMManagedInstanceCore-', !Ref 'AWS::Region'] ]
          Action:
            - kms:DescribeKey
            - kms:Encrypt
            - kms:Decrypt
            - kms:ReEncrypt*
            - kms:GenerateDataKey
            - kms:GenerateDataKeyWithoutPlaintext
          Resource: '*'
        - Sid: Allow use of the key by CloudWatch Logs
          Effect: Allow
          Principal:
            Service: !Join [ '.', ['logs', !Ref 'AWS::Region', 'amazonaws.com'] ]
          Action:
          - kms:Encrypt*
          - kms:Decrypt*
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:Describe*
          Resource: "*"
          # Condition:
            # ArnLike:
              # !Sub 'kms:EncryptionContext:aws:logs:arn: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:session-manager'

  #-------------------------------------------------
  #!Sub 'kms:EncryptionContext:aws:logs:arn: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:session-manager'
  #kms:EncryptionContext:aws:logs:arn: arn:aws:logs:us-west-2:052160528869:log-group:session-manager
  #kms:EncryptionContext:aws:logs:arn: arn:aws:logs:us-east-1:286949207354:log-group:session-manager

  SessionManagerDataEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/session-manager
      TargetKeyId: !Ref SessionManagerDataEncryptionKey

  #-------------------------------------------------
  # CloudWatch Log Group for Session Manager logs
  #-------------------------------------------------
  CloudWatchLogGroupSessionManager:
    Type: AWS::Logs::LogGroup
    Properties: 
      KmsKeyId: !GetAtt SessionManagerDataEncryptionKey.Arn
      LogGroupName: 'session-manager'
      RetentionInDays: 60

  #-------------------------------------------------
  # Session Manager preferences document
  #-------------------------------------------------
  SessionManagerPreferencesDocument:
    Type: AWS::SSM::Document
    Properties: 
      Content:
        schemaVersion: '1.0'
        description: Document to hold regional settings for Session Manager
        sessionType: Standard_Stream
        inputs:
          s3BucketName: ''
          s3KeyPrefix: ''
          s3EncryptionEnabled: false
          cloudWatchLogGroupName: !Ref CloudWatchLogGroupSessionManager
          cloudWatchEncryptionEnabled: true
          idleSessionTimeout: '20'
          cloudWatchStreamingEnabled: true
          kmsKeyId: !Ref SessionManagerDataEncryptionKey
          runAsEnabled: true
          runAsDefaultUser: ec2-user
          shellProfile:
            windows: ''
            linux: ''
      DocumentType: Session
      Name: SSM-SessionManagerRunShell

  #-------------------------------------------------
  # VPC and required resources to enable network connectivity to AWS Systems Manager
  #-------------------------------------------------
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      InstanceTenancy: default
      Tags:
      - Key: Name
        Value: SSM-Workshop-CF
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
      - Key: Name
        Value: SSM-Workshop-CF
  VPCGatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  SubnetPublic:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.0.0/20
      MapPublicIpOnLaunch: true
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: SSM-Workshop-CF
  RouteTablePublic:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: SSM-Workshop-CF
  RouteTableAssociationPublic:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref SubnetPublic
      RouteTableId: !Ref RouteTablePublic
  RouteTablePublicInternetRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTablePublic
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway
  NetworkAclPublic:
    Type: 'AWS::EC2::NetworkAcl'
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: SSM-Workshop-CF
  SubnetNetworkAclAssociationPublic:
    Type: 'AWS::EC2::SubnetNetworkAclAssociation'
    Properties:
      SubnetId: !Ref SubnetPublic
      NetworkAclId: !Ref NetworkAclPublic
  NetworkAclEntryInPublicAllowAll:
    Type: 'AWS::EC2::NetworkAclEntry'
    Properties:
      NetworkAclId: !Ref NetworkAclPublic
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: false
      CidrBlock: '0.0.0.0/0'
  NetworkAclEntryOutPublicAllowAll:
    Type: 'AWS::EC2::NetworkAclEntry'
    Properties:
      NetworkAclId: !Ref NetworkAclPublic
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: true
      CidrBlock: '0.0.0.0/0'
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security Group for SSM Workshop test instances"
      GroupName: SSM-Workshop-CF
      SecurityGroupEgress: 
        - IpProtocol: -1
          FromPort: 0
          ToPort: 65535
          CidrIp: 0.0.0.0/0
      Tags: 
        - Key: Name
          Value: SSM-Workshop-CF
      VpcId: !Ref VPC

  #-------------------------------------------------
  # Four Amazon Linux 2 EC2 instances using the latest AMI for Amazon Linux 2
  #-------------------------------------------------
  LinuxEc2InstanceOne: 
    Type: AWS::EC2::Instance
    Properties: 
      InstanceType: t2.small
      ImageId: !Ref LatestAmazonLinuxAmiId
      NetworkInterfaces: 
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet: 
            - Ref: "InstanceSecurityGroup"
          SubnetId: 
            Ref: "SubnetPublic"
      IamInstanceProfile: !Sub 'ManagedInstanceProfile-${AWS::Region}'
      Tags:
        - Key: Name
          Value: App1
  LinuxEc2InstanceTwo: 
    Type: AWS::EC2::Instance
    Properties: 
      InstanceType: t2.small
      ImageId: !Ref LatestAmazonLinuxAmiId
      NetworkInterfaces: 
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet: 
            - Ref: "InstanceSecurityGroup"
          SubnetId: 
            Ref: "SubnetPublic"
      IamInstanceProfile: !Sub 'ManagedInstanceProfile-${AWS::Region}'
      Tags:
        - Key: Name
          Value: App2
  LinuxEc2InstanceThree: 
    Type: AWS::EC2::Instance
    Properties: 
      InstanceType: t2.small
      ImageId: !Ref LatestAmazonLinuxAmiId
      NetworkInterfaces: 
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet: 
            - Ref: "InstanceSecurityGroup"
          SubnetId: 
            Ref: "SubnetPublic"
      IamInstanceProfile: !Sub 'ManagedInstanceProfile-${AWS::Region}'
      Tags:
        - Key: Name
          Value: Web1
  LinuxEc2InstanceFour: 
    Type: AWS::EC2::Instance
    Properties: 
      InstanceType: t2.small
      ImageId: !Ref LatestAmazonLinuxAmiId
      NetworkInterfaces: 
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet: 
            - Ref: "InstanceSecurityGroup"
          SubnetId: 
            Ref: "SubnetPublic"
      IamInstanceProfile: !Sub 'ManagedInstanceProfile-${AWS::Region}'
      Tags:
        - Key: Name
          Value: Web2

Outputs:
  ResouceSyncBucketName:
    Description: The name of the S3 bucket used to store resource data sync details.
    Value: !Ref ResouceSyncBucket
  CommandLogsBucketName:
    Description: The name of the S3 bucket used to store command logs centrally.
    Value: !Ref CommandLogsBucket
  ManagedInstanceDataEncryptionKey:
    Description: The ARN of the KMS key used to encrypt resource data sync logs.
    Value: !GetAtt ManagedInstanceDataEncryptionKey.Arn